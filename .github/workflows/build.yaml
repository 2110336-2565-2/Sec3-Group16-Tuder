name: Tuder GitHub Actions
on:
  push:
    branches:
      - develop

jobs:
  initialize-the-application:
    runs-on: ubuntu-latest
    env:
      MODE: ${{vars.MODE}}
      SERVER_PORT: ${{vars.SERVER_PORT}}
      SERVER_HOST: ${{vars.SERVER_HOST}}
      DB_USER: ${{vars.DB_USER}}
      DB_PASSWORD: ${{vars.DB_PASSWORD}}
      DB_NAME: ${{vars.DB_NAME}}
      DB_PORT: ${{vars.DB_PORT}}
      JWT_SECRET: ${{vars.JWT_SECRET}}
      JWT_EXPIRES_MINUTES: ${{vars.JWT_EXPIRES_MINUTES}}
      FRONTEND_URL: ${{vars.FRONTEND_URL}}
      AWS_REGION: ${{secrets.AWS_REGION}}
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      OMISE_PUBLIC_KEY: ${{secrets.OMISE_PUBLIC_KEY}}
      OMISE_SECRET_KEY:
        ${{secrets.OMISE_SECRET_KEY}}
        #  -------------------
      PORT: ${{vars.PORT}}
      REACT_APP_API_URL: ${{vars.REACT_APP_API_URL}}
      REACT_APP_OMISE_PUBLIC_KEY: ${{vars.REACT_APP_OMISE_PUBLIC_KEY}}
      DOCKER_ACCESS_TOKEN: ${{secrets.DOCKER_ACCESS_TOKEN}}

    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Pull from git
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          ref: "develop"
      - name: ls workspace
        run: ls ${{ github.workspace }}
      - name: Create .env in backend
        run: |
          cd Backend
          touch .env
          cd ..
      - name: Login to DockerHub Registry
        run: echo ${{ secrets.DOCKER_ACCESS_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
      - name: Docker compose up
        run: |
          docker-compose up -d --build
      - name: Push image to DockerHub Registry
        run: docker-compose push
      - name: echo "ðŸ This job's status is ${{ job.status }}."
        run: echo "ðŸ This job's status is ${{ job.status }}."

  Deploy:
    needs: initialize-the-application
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Deploy in EC2
        env:
          PRIVATE_KEY: ${{ secrets.AWS_PRIVATE_KEY }}
          HOSTNAME: ${{ secrets.HOSTNAME }}
          USER_NAME: ${{ secrets.USER_NAME }}

        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '
            # Now we have got the access of EC2 and we will start the deploy.
            sudo docker-compose down &&
            sudo docker-compose pull &&
            sudo docker-compose up -d
            # Remove unused image
            sudo docker image prune
          '
